# ddvpn-webhook-tgbot

Webhook-–±–æ—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ **[Remnawave](https://github.com/remnawave/panel)** –∏ **[Observer](https://github.com/0FL01/remnawave-observer)** —Å Telegram.
–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –æ —Å–æ–±—ã—Ç–∏—è—Ö –Ω–æ–¥, —Å–µ—Ä–≤–∏—Å–æ–≤, –ø–ª–∞—Ç–µ–∂–µ–π –∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π Telegram-—á–∞—Ç.

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. Remnawave

–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –æ—Ç Remnawave –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∏—Ö –ø–æ —Å–ø–∏—Å–∫—É —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `config/events.yaml`.

–°–æ–±—ã—Ç–∏—è –º–æ–≥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —Ä–∞–∑–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: –Ω–æ–¥—ã, —Å–µ—Ä–≤–∏—Å—ã, –ø–ª–∞—Ç–µ–∂–∏ –∏ —Ç.–¥.

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ **Jinja2 —à–∞–±–ª–æ–Ω—ã** (`templates/`) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Telegram —Å –∫—Ä–∞—Å–∏–≤—ã–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º, –≤–∫–ª—é—á–∞—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ö–µ—à—Ç–µ–≥ —Å–æ–±—ã—Ç–∏—è (`#event_name`).

> ‚ö†Ô∏è –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω—è—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è `config/events.yaml`. –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.

> ‚ö†Ô∏è –®–∞–±–ª–æ–Ω —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ –ø–∞–ø–∫–µ `templates` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –±–æ—Ç–∞.

### 2. Observer

–ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –≤–µ–±—Ö—É–∫–∏ –æ–± –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ IP-–∞–¥—Ä–µ—Å–æ–≤:

**–ü—Ä–∏–º–µ—Ä JSON:**

```json
{
	"user_identifier": "54_217217281",
	"detected_ips_count": 13,
	"limit": 12,
	"all_user_ips": ["1.1.1.1", "2.2.2.2", "3.3.3.3"],
	"block_duration": "5m",
	"violation_type": "ip_limit_exceeded"
}
```

**–ü—Ä–∏–º–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:**

```
üö® #alert
‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: 54_217217281
üì° –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç IP-–∞–¥—Ä–µ—Å–æ–≤: 13 / 12
‚è± –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞: 5m
üñß IP-–∞–¥—Ä–µ—Å–∞:
1.1.1.1, 2.2.2.2, 3.3.3.3
‚ö† –¢–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è: ip_limit_exceeded
```

–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω –≤ URL (`/webhook/alert/<ALERT_SECRET>`), —á—Ç–æ–±—ã –Ω–∏–∫—Ç–æ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –Ω–µ –º–æ–≥ —Å–ª–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

> ‚ö†Ô∏è –ò–∑–º–µ–Ω—è—Ç—å —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–Ω–æ –≤ –ø–∞–ø–∫–µ `templates` - –±–æ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/fxfuren/ddvpn-webhook-tgbot.git
cd ddvpn-webhook-tgbot/bot
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
python -m venv venv
source venv/bin/activate   # Linux/macOS
venv\Scripts\activate      # Windows

pip install --upgrade pip
pip install -r requirements.txt
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env`

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ `bot`:

```env
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω
TELEGRAM_CHAT_ID=–≤–∞—à_—á–∞—Ç_id
BOT_INTERNAL_PORT=8080
DOMAIN=https://–≤–∞—à_–¥–æ–º–µ–Ω.com

# Remnawave
REMNAWAVE_WEBHOOK_SECRET=—Å–µ–∫—Ä–µ—Ç_–¥–ª—è_–ø—Ä–æ–≤–µ—Ä–∫–∏_–ø–æ–¥–ø–∏—Å–µ–π

# Alert webhook (Observer)
ALERT_WEBHOOK_SECRET=—Å–µ–∫—Ä–µ—Ç_–¥–ª—è_alerts
```

## –ó–∞–ø—É—Å–∫

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (ngrok)

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ [ngrok](https://ngrok.com/) –∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:

```bash
ngrok http 8080
```

2. –í `.env` —É–∫–∞–∂–∏—Ç–µ `DOMAIN=https://<ngrok-—Å—Å—ã–ª–∫–∞>`

3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Remnawave –∏ Observer –Ω–∞ –≤–∞—à ngrok URL:

```
REMNAWAVE_WEBHOOK_URL=https://<ngrok-—Å—Å—ã–ª–∫–∞>/webhook/remnawave
ALERT_WEBHOOK_URL=https://<ngrok-—Å—Å—ã–ª–∫–∞>/webhook/alert/<ALERT_SECRET>
```

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:

```bash
python -m bot.main
```

## –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ VPS —Å –¥–æ–º–µ–Ω–æ–º —á–µ—Ä–µ–∑ Docker Compose

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Let‚Äôs Encrypt) –∏ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ VPS –ø–æ –ø—É—Ç–∏:

```
/etc/letsencrypt/live/<–≤–∞—à_–¥–æ–º–µ–Ω>/fullchain.pem
/etc/letsencrypt/live/<–≤–∞—à_–¥–æ–º–µ–Ω>/privkey.pem
```

> ‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ.

### 2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –∫ `remnawave-nginx`

–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `remnawave-nginx` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –¥–æ–±–∞–≤—å—Ç–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –≤ –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `docker-compose.yml`:

```yaml
volumes:
  - /etc/letsencrypt/live/<–≤–∞—à_–¥–æ–º–µ–Ω>/fullchain.pem:/etc/nginx/ssl/<–≤–∞—à_–¥–æ–º–µ–Ω>/fullchain.pem:ro
  - /etc/letsencrypt/live/<–≤–∞—à_–¥–æ–º–µ–Ω>/privkey.pem:/etc/nginx/ssl/<–≤–∞—à_–¥–æ–º–µ–Ω>/privkey.pem:ro
```

### 3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `remnawave-nginx`

–î–æ–±–∞–≤—å—Ç–µ –±–ª–æ–∫ –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –≤ `nginx.conf`:

```nginx
server {
    server_name <–≤–∞—à_–¥–æ–º–µ–Ω>;

    listen unix:/dev/shm/nginx.sock ssl proxy_protocol;
    http2 on;

    ssl_certificate "/etc/nginx/ssl/<–≤–∞—à_–¥–æ–º–µ–Ω>/fullchain.pem";
    ssl_certificate_key "/etc/nginx/ssl/<–≤–∞—à_–¥–æ–º–µ–Ω>/privkey.pem";
    ssl_trusted_certificate "/etc/nginx/ssl/<–≤–∞—à_–¥–æ–º–µ–Ω>/fullchain.pem";

    location / {
        proxy_pass http://127.0.0.1:8080; # –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∞—à —Å–µ—Ä–≤–∏—Å
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–µ–±—Ö—É–∫–∏ –¥–ª—è **remnawave** –∏ **observer-alert**:

```bash
REMNAWAVE_WEBHOOK_URL=https://<–≤–∞—à_–¥–æ–º–µ–Ω>/webhook/remnawave
ALERT_WEBHOOK_URL=https://<–≤–∞—à_–¥–æ–º–µ–Ω>/webhook/alert/<ALERT_SECRET>
```

### 5. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ `remnawave-nginx`, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```bash
docker-compose restart remnawave-nginx
```

–¢–µ–ø–µ—Ä—å –≤–∞—à —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ SSL –Ω–∞ –≤–∞—à–µ–º –¥–æ–º–µ–Ω–µ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `remnawave-nginx`.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
bot/
‚îú‚îÄ‚îÄ main.py                 # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∑–∞–ø—É—Å–∫–∞–µ—Ç aiohttp —Å–µ—Ä–≤–µ—Ä
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ remnawave_handler.py  # –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook Remnawave
‚îÇ   ‚îú‚îÄ‚îÄ alert_handler.py      # –û–±—Ä–∞–±–æ—Ç–∫–∞ AlertPayload –æ—Ç Observer
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ config.py           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ .env
‚îÇ   ‚îú‚îÄ‚îÄ logger.py           # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ verify_signature.py # –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏ Remnawave
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ node.html
‚îÇ   ‚îú‚îÄ‚îÄ service.html
‚îÇ   ‚îú‚îÄ‚îÄ billing.html
‚îÇ   ‚îú‚îÄ‚îÄ generic.html
‚îÇ   ‚îî‚îÄ‚îÄ alert.html          # –®–∞–±–ª–æ–Ω –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Observer
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ events.yaml         # –°–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è)
‚îî‚îÄ‚îÄ requirements.txt
docker-compose.yml
Dockerfile
.env.example
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å HTML –∏ —ç–º–æ–¥–∑–∏.
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ö–µ—à—Ç–µ–≥–∏ –¥–ª—è —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è (`#login_attempt_success`, `#ip_limit_exceeded`).
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–µ–π Remnawave —á–µ—Ä–µ–∑ HMAC SHA256.
- –ó–∞—â–∏—Ç–∞ –≤–µ–±—Ö—É–∫–æ–≤ AlertPayload —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç –≤ URL.
- –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª—å –∏ –≤ —Ñ–∞–π–ª `bot.log` —Å —Ä–æ—Ç–∞—Ü–∏–µ–π.
- –ò–∑–º–µ–Ω—è–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ `templates/` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker Compose –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ VPS.
